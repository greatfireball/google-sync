#!/usr/bin/env Rscript
library(tidyverse)
library(googlesheets)
key <- "1ZvA2mq8e99BPECqA_B_YIeVp-1vvnlNBf6GG0CAfehQ"
ss1 <- gs_key(key)

# split sheet into tsvs
working_sheets <- ss1 %>% gs_ws_ls()

for (ws in working_sheets){
    ws_a <- paste0(paste0("tmp_", ss1$sheet_title, "_"), ws, '.tsv')
    ws_b <- paste0(paste0(ss1$sheet_title, "_"), ws, '.tsv')

    # if local copy was deleted - also delete on gd
    if(!file.exists(ws_b)){
        ss1 %>% gs_ws_delete(ws)
        ss1 <- ss1 %>% gs_gs() # re-register
        next
    }
    
    # if local copy exists: download and diff
    ss1 %>% gs_read(ws) %>%
        mutate_all(as.character) %>% # prevent scientific notation and weird dates
        write_tsv(ws_a)
    # diff
    ws_diff <- system2("diff", c(ws_a, ws_b))
    # upload only if diff
    if(ws_diff){
        ss1 %>% gs_ws_delete(ws)
        ss1 <- ss1 %>% gs_gs() # re-register
        ss1 %>% gs_ws_new(ws, input=read_tsv(ws_b))
        ss1 <- ss1 %>% gs_gs() # re-register
    }else{
        write(paste0("No changes in: ", ws, ". Skipping upload"), stderr())
    }
    file.remove(ws_a)
}
