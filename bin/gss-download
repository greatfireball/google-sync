#!/usr/bin/env Rscript
library(tidyverse)
library(googlesheets)
key <- "1ZvA2mq8e99BPECqA_B_YIeVp-1vvnlNBf6GG0CAfehQ"
ss1 <- gs_key(key)

# split sheet into tsvs
working_sheets <- ss1 %>% gs_ws_ls()
ws_pre <- paste0(ss1$sheet_title, "_")
for (ws in working_sheets){
    ws_tsv <- paste0(paste0(ss1$sheet_title, "_"), ws, '.tsv')
    ws_new <- paste0(paste0(ss1$sheet_title, "_"), ws, '.tsv.new')
    ws_bak <- paste0(paste0(ss1$sheet_title, "_"), ws, '.tsv.bak')

    # download all to .new
    ss1 %>% gs_read(ws) %>%
        mutate_all(as.character) %>% # prevent scientific notation and weird dates
        write_tsv(ws_new)

    # bak old files of existing and different
    if(file.exists(ws_tsv) && system2("diff", c(ws_tsv, ws_new))){
        write(paste0("New content in ", ws_tsv,"backuped old version to ", ws_bak), stderr())
        file.rename(ws_tsv, ws_bak)
    }
    # rename newly downloaded files
    file.rename(ws_new, ws_tsv)
}
